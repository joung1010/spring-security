# Spring Security Authorization Events

## ê°œìš”

Spring SecurityëŠ” ì¸ê°€(Authorization) ì²˜ë¦¬ ê³¼ì •ì—ì„œë„ ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤. ì¸ê°€ ì„±ê³µ ë˜ëŠ” ì‹¤íŒ¨ ì‹œ `AuthorizationGrantedEvent` ë˜ëŠ” `AuthorizationDeniedEvent`ë¥¼ ë°œí–‰í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì¸ê°€ ê´€ë ¨ ë¡œê¹…, ëª¨ë‹ˆí„°ë§, ê°ì‚¬ ë“±ì˜ ì¶”ê°€ ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.

## ì´ë²¤íŠ¸ ë°œí–‰ ë°©ë²•

### ë°œí–‰ API

- `ApplicationEventPublisher.publishEvent(ApplicationEvent)`
- `AuthorizationEventPublisher.publishAuthorizationEvent(Supplier<Authentication>, T, AuthorizationDecision)`

### ìˆ˜ì‹  ë°©ë²•

```java
@Component
public class AuthorizationEvents {
    
    @EventListener
    public void onGranted(AuthorizationGrantedEvent event) { ... }

    @EventListener
    public void onDenied(AuthorizationDeniedEvent event) { ... }
}
```

---

## ì¸ê°€ ì´ë²¤íŠ¸ ì¢…ë¥˜

### ìƒìœ„ ì´ë²¤íŠ¸ í´ë˜ìŠ¤

### 1. AuthorizationEvent

```java
public abstract class AuthorizationEvent extends ApplicationEvent {
    private final Supplier<Authentication> authentication;
    private final Object object;
    private final AuthorizationDecision decision;
    
    public AuthorizationEvent(Supplier<Authentication> authentication, Object object, AuthorizationDecision decision) {
        super(authentication);
        this.authentication = authentication;
        this.object = object;
        this.decision = decision;
    }
    
    public Supplier<Authentication> getAuthentication() {
        return authentication;
    }
    
    public Object getObject() {
        return object;
    }
    
    public AuthorizationDecision getAuthorizationDecision() {
        return decision;
    }
}
```

- **ì—­í• **: ëª¨ë“  ì¸ê°€ ì´ë²¤íŠ¸ì˜ ìƒìœ„ í´ë˜ìŠ¤
- **í¬í•¨**: ì¸ì¦ ì •ë³´, ë³´í˜¸ëœ ê°ì²´, ì¸ê°€ ê²°ì • ì •ë³´

### ì¸ê°€ ì´ë²¤íŠ¸ í´ë˜ìŠ¤

### 1. AuthorizationGrantedEvent

```java
public final class AuthorizationGrantedEvent extends AuthorizationEvent {
    
    public AuthorizationGrantedEvent(Supplier<Authentication> authentication, Object object, AuthorizationDecision decision) {
        super(authentication, object, decision);
    }
}
```

- **ë°œìƒ ì‹œì **: ì¸ê°€ê°€ ì„±ê³µí–ˆì„ ë•Œ
- **ìš©ë„**: ì„±ê³µì ì¸ ì ‘ê·¼ ì‹œë„ ê¸°ë¡

### 2. AuthorizationDeniedEvent

```java
public final class AuthorizationDeniedEvent extends AuthorizationEvent {
    
    public AuthorizationDeniedEvent(Supplier<Authentication> authentication, Object object, AuthorizationDecision decision) {
        super(authentication, object, decision);
    }
}
```

- **ë°œìƒ ì‹œì **: ì¸ê°€ê°€ ê±°ë¶€ë˜ì—ˆì„ ë•Œ
- **ìš©ë„**: ì‹¤íŒ¨í•œ ì ‘ê·¼ ì‹œë„ ê¸°ë¡, ë³´ì•ˆ ìœ„í˜‘ íƒì§€

---

## Spring Securityì—ì„œ ì‹¤ì œ ì¸ê°€ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•˜ëŠ” ì½”ë“œ

### 1. AuthorizationFilterì—ì„œ ì¸ê°€ ì´ë²¤íŠ¸ ë°œí–‰

```java
public class AuthorizationFilter extends GenericFilterBean {
    
    private final AuthorizationManager<HttpServletRequest> authorizationManager;
    private AuthorizationEventPublisher eventPublisher = AuthorizationFilter::noPublish;
    
    public AuthorizationFilter(AuthorizationManager<HttpServletRequest> authorizationManager) {
        Assert.notNull(authorizationManager, "authorizationManager cannot be null");
        this.authorizationManager = authorizationManager;
    }
    
    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain chain)
            throws ServletException, IOException {
        
        HttpServletRequest request = (HttpServletRequest) servletRequest;
        HttpServletResponse response = (HttpServletResponse) servletResponse;
        
        if (this.observeOncePerRequest && isApplied(request)) {
            chain.doFilter(request, response);
            return;
        }
        
        if (skipDispatch(request)) {
            chain.doFilter(request, response);
            return;
        }
        
        if (this.observeOncePerRequest) {
            request.setAttribute(FILTER_APPLIED, Boolean.TRUE);
        }
        
        try {
            // ğŸ”¥ ì¸ê°€ ê²°ì • ìˆ˜í–‰
            AuthorizationDecision decision = this.authorizationManager.check(this::getAuthentication, request);
            
            // ğŸ”¥ ì¸ê°€ ì´ë²¤íŠ¸ ë°œí–‰
            this.eventPublisher.publishAuthorizationEvent(this::getAuthentication, request, decision);
            
            if (decision != null && !decision.isGranted()) {
                throw new AccessDeniedException("Access Denied");
            }
            
            chain.doFilter(request, response);
        }
        finally {
            if (this.observeOncePerRequest) {
                request.removeAttribute(FILTER_APPLIED);
            }
        }
    }
    
    private Authentication getAuthentication() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication == null) {
            throw new AuthenticationCredentialsNotFoundException(
                    "An Authentication object was not found in the SecurityContext");
        }
        return authentication;
    }
    
    public void setAuthorizationEventPublisher(AuthorizationEventPublisher eventPublisher) {
        Assert.notNull(eventPublisher, "eventPublisher cannot be null");
        this.eventPublisher = eventPublisher;
    }
    
    private static void noPublish(Supplier<Authentication> authentication, Object object, AuthorizationDecision decision) {
        // ê¸°ë³¸ ë™ì‘: ì´ë²¤íŠ¸ ë°œí–‰ ì•ˆí•¨
    }
}
```

### 2. AuthorizationManagerBeforeMethodInterceptorì—ì„œ ë©”ì„œë“œ ì¸ê°€ ì´ë²¤íŠ¸ ë°œí–‰

```java
public final class AuthorizationManagerBeforeMethodInterceptor implements MethodInterceptor {
    
    private final AuthorizationManager<MethodInvocation> authorizationManager;
    private AuthorizationEventPublisher eventPublisher = AuthorizationManagerBeforeMethodInterceptor::noPublish;
    
    public AuthorizationManagerBeforeMethodInterceptor(AuthorizationManager<MethodInvocation> authorizationManager) {
        this.authorizationManager = authorizationManager;
    }
    
    @Override
    public Object invoke(MethodInvocation methodInvocation) throws Throwable {
        // ğŸ”¥ ë©”ì„œë“œ ì¸ê°€ ê²°ì • ìˆ˜í–‰
        AuthorizationDecision decision = this.authorizationManager.check(this::getAuthentication, methodInvocation);
        
        // ğŸ”¥ ë©”ì„œë“œ ì¸ê°€ ì´ë²¤íŠ¸ ë°œí–‰
        this.eventPublisher.publishAuthorizationEvent(this::getAuthentication, methodInvocation, decision);
        
        if (decision != null && !decision.isGranted()) {
            throw new AccessDeniedException("Access Denied");
        }
        
        return methodInvocation.proceed();
    }
    
    private Authentication getAuthentication() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication == null) {
            throw new AuthenticationCredentialsNotFoundException(
                    "An Authentication object was not found in the SecurityContext");
        }
        return authentication;
    }
    
    public void setAuthorizationEventPublisher(AuthorizationEventPublisher eventPublisher) {
        Assert.notNull(eventPublisher, "eventPublisher cannot be null");
        this.eventPublisher = eventPublisher;
    }
    
    private static void noPublish(Supplier<Authentication> authentication, Object object, AuthorizationDecision decision) {
        // ê¸°ë³¸ ë™ì‘: ì´ë²¤íŠ¸ ë°œí–‰ ì•ˆí•¨
    }
}
```

### 3. AuthorizationManagerAfterMethodInterceptorì—ì„œ ì‚¬í›„ ì¸ê°€ ì´ë²¤íŠ¸ ë°œí–‰

```java
public final class AuthorizationManagerAfterMethodInterceptor implements MethodInterceptor {
    
    private final AuthorizationManager<MethodInvocationResult> authorizationManager;
    private AuthorizationEventPublisher eventPublisher = AuthorizationManagerAfterMethodInterceptor::noPublish;
    
    public AuthorizationManagerAfterMethodInterceptor(AuthorizationManager<MethodInvocationResult> authorizationManager) {
        this.authorizationManager = authorizationManager;
    }
    
    @Override
    public Object invoke(MethodInvocation methodInvocation) throws Throwable {
        Object result = methodInvocation.proceed();
        
        MethodInvocationResult invocationResult = new MethodInvocationResult(methodInvocation, result);
        
        // ğŸ”¥ ì‚¬í›„ ì¸ê°€ ê²°ì • ìˆ˜í–‰
        AuthorizationDecision decision = this.authorizationManager.check(this::getAuthentication, invocationResult);
        
        // ğŸ”¥ ì‚¬í›„ ì¸ê°€ ì´ë²¤íŠ¸ ë°œí–‰
        this.eventPublisher.publishAuthorizationEvent(this::getAuthentication, invocationResult, decision);
        
        if (decision != null && !decision.isGranted()) {
            throw new AccessDeniedException("Access Denied");
        }
        
        return result;
    }
    
    private Authentication getAuthentication() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication == null) {
            throw new AuthenticationCredentialsNotFoundException(
                    "An Authentication object was not found in the SecurityContext");
        }
        return authentication;
    }
    
    public void setAuthorizationEventPublisher(AuthorizationEventPublisher eventPublisher) {
        Assert.notNull(eventPublisher, "eventPublisher cannot be null");
        this.eventPublisher = eventPublisher;
    }
    
    private static void noPublish(Supplier<Authentication> authentication, Object object, AuthorizationDecision decision) {
        // ê¸°ë³¸ ë™ì‘: ì´ë²¤íŠ¸ ë°œí–‰ ì•ˆí•¨
    }
}
```

### 4. SpringAuthorizationEventPublisherì—ì„œ ì‹¤ì œ ì´ë²¤íŠ¸ ë°œí–‰

```java
public final class SpringAuthorizationEventPublisher implements AuthorizationEventPublisher {
    
    private final ApplicationEventPublisher publisher;
    
    public SpringAuthorizationEventPublisher(ApplicationEventPublisher publisher) {
        Assert.notNull(publisher, "publisher cannot be null");
        this.publisher = publisher;
    }
    
    @Override
    public <T> void publishAuthorizationEvent(Supplier<Authentication> authentication, T object, AuthorizationDecision decision) {
        Assert.notNull(authentication, "authentication supplier cannot be null");
        Assert.notNull(object, "object cannot be null");
        Assert.notNull(decision, "decision cannot be null");
        
        if (decision.isGranted()) {
            // ğŸ”¥ ì¸ê°€ ì„±ê³µ ì´ë²¤íŠ¸ ë°œí–‰
            this.publisher.publishEvent(new AuthorizationGrantedEvent(authentication, object, decision));
        } else {
            // ğŸ”¥ ì¸ê°€ ê±°ë¶€ ì´ë²¤íŠ¸ ë°œí–‰
            this.publisher.publishEvent(new AuthorizationDeniedEvent(authentication, object, decision));
        }
    }
}
```

### 5. AuthorizationManager êµ¬í˜„ì²´ì—ì„œ ê²°ì • ìƒì„±

```java
public final class AuthorityAuthorizationManager<T> implements AuthorizationManager<T> {
    
    private final List<GrantedAuthority> authorities;
    
    @Override
    public AuthorizationDecision check(Supplier<Authentication> authentication, T object) {
        // ğŸ”¥ ê¶Œí•œ ê²€ì‚¬ ìˆ˜í–‰
        boolean granted = isGranted(authentication.get());
        
        // ğŸ”¥ AuthorizationDecision ë°˜í™˜ (ì´í›„ ì´ë²¤íŠ¸ ë°œí–‰ì— ì‚¬ìš©ë¨)
        return new AuthorizationDecision(granted);
    }
    
    private boolean isGranted(Authentication authentication) {
        return authentication != null && 
               authentication.isAuthenticated() && 
               authentication.getAuthorities().stream()
                   .anyMatch(this.authorities::contains);
    }
}
```

---

## ì¸ê°€ ì´ë²¤íŠ¸ ë°œí–‰ & ìˆ˜ì‹  ì˜ˆì œ

### 1. ì¸ê°€ ì´ë²¤íŠ¸ ìˆ˜ì‹ ì êµ¬í˜„

```java
@Component
public class AuthorizationEvents {
    
    // ì¸ê°€ ì„±ê³µ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    @EventListener
    public void onGranted(AuthorizationGrantedEvent event) {
        Authentication auth = event.getAuthentication().get();
        Object protectedObject = event.getObject();
        
        System.out.println("=== ì¸ê°€ ì„±ê³µ ===");
        System.out.println("ì‚¬ìš©ì: " + auth.getName());
        System.out.println("ê¶Œí•œ: " + auth.getAuthorities());
        System.out.println("ë³´í˜¸ëœ ê°ì²´: " + getObjectDescription(protectedObject));
        System.out.println("ê²°ì • ì‹ ë¢°ë„: " + event.getAuthorizationDecision().getClass().getSimpleName());
        
        // ì„±ê³µì ì¸ ì ‘ê·¼ ë¡œê¹…
        logSuccessfulAccess(auth, protectedObject);
    }
    
    // ì¸ê°€ ê±°ë¶€ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    @EventListener
    public void onDenied(AuthorizationDeniedEvent event) {
        Authentication auth = event.getAuthentication().get();
        Object protectedObject = event.getObject();
        
        System.out.println("=== ì¸ê°€ ê±°ë¶€ ===");
        System.out.println("ì‚¬ìš©ì: " + (auth != null ? auth.getName() : "anonymous"));
        System.out.println("ê¶Œí•œ: " + (auth != null ? auth.getAuthorities() : "none"));
        System.out.println("ë³´í˜¸ëœ ê°ì²´: " + getObjectDescription(protectedObject));
        System.out.println("ê±°ë¶€ ì´ìœ : Access Denied");
        
        // ê±°ë¶€ëœ ì ‘ê·¼ ì‹œë„ ë¡œê¹… ë° ë³´ì•ˆ ì•Œë¦¼
        logDeniedAccess(auth, protectedObject);
        checkForSuspiciousActivity(auth, protectedObject);
    }
    
    // ëª¨ë“  ì¸ê°€ ì´ë²¤íŠ¸ ìˆ˜ì‹  (ê³µí†µ ì²˜ë¦¬)
    @EventListener
    public void onAnyAuthorization(AuthorizationEvent event) {
        System.out.println("=== ì¸ê°€ ì´ë²¤íŠ¸ (ê³µí†µ) ===");
        System.out.println("ì´ë²¤íŠ¸ íƒ€ì…: " + event.getClass().getSimpleName());
        System.out.println("ê²°ì •: " + (event.getAuthorizationDecision().isGranted() ? "í—ˆìš©" : "ê±°ë¶€"));
        System.out.println("ì‹œê°„: " + new Date());
        
        // ëª¨ë“  ì¸ê°€ ì‹œë„ì— ëŒ€í•œ í†µê³„ ìˆ˜ì§‘
        collectAuthorizationStatistics(event);
    }
    
    private String getObjectDescription(Object protectedObject) {
        if (protectedObject instanceof HttpServletRequest) {
            HttpServletRequest request = (HttpServletRequest) protectedObject;
            return String.format("HTTP %s %s", request.getMethod(), request.getRequestURI());
        } else if (protectedObject instanceof MethodInvocation) {
            MethodInvocation method = (MethodInvocation) protectedObject;
            return String.format("Method %s.%s()", 
                method.getMethod().getDeclaringClass().getSimpleName(),
                method.getMethod().getName());
        } else if (protectedObject instanceof MethodInvocationResult) {
            MethodInvocationResult result = (MethodInvocationResult) protectedObject;
            MethodInvocation method = result.getMethodInvocation();
            return String.format("Method Result %s.%s() -> %s", 
                method.getMethod().getDeclaringClass().getSimpleName(),
                method.getMethod().getName(),
                result.getResult() != null ? result.getResult().getClass().getSimpleName() : "null");
        }
        return protectedObject.toString();
    }
    
    private void logSuccessfulAccess(Authentication auth, Object protectedObject) {
        System.out.println("âœ… ì„±ê³µì ì¸ ì ‘ê·¼ ë¡œê·¸ ê¸°ë¡: " + auth.getName());
    }
    
    private void logDeniedAccess(Authentication auth, Object protectedObject) {
        System.err.println("âŒ ê±°ë¶€ëœ ì ‘ê·¼ ë¡œê·¸ ê¸°ë¡: " + 
                          (auth != null ? auth.getName() : "anonymous"));
    }
    
    private void checkForSuspiciousActivity(Authentication auth, Object protectedObject) {
        System.out.println("ğŸ” ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í™œë™ ê²€ì‚¬ ìˆ˜í–‰");
    }
    
    private void collectAuthorizationStatistics(AuthorizationEvent event) {
        System.out.println("ğŸ“Š ì¸ê°€ í†µê³„ ìˆ˜ì§‘");
    }
}
```

### 2. HTTP ìš”ì²­ ì¸ê°€ ì´ë²¤íŠ¸ ìƒì„¸ ì²˜ë¦¬

```java
@Component
public class HttpAuthorizationEvents {
    
    @EventListener
    public void onHttpGranted(AuthorizationGrantedEvent event) {
        if (event.getObject() instanceof HttpServletRequest) {
            HttpServletRequest request = (HttpServletRequest) event.getObject();
            Authentication auth = event.getAuthentication().get();
            
            System.out.println("=== HTTP ìš”ì²­ ì¸ê°€ ì„±ê³µ ===");
            System.out.println("ì‚¬ìš©ì: " + auth.getName());
            System.out.println("ìš”ì²­: " + request.getMethod() + " " + request.getRequestURI());
            System.out.println("í´ë¼ì´ì–¸íŠ¸ IP: " + getClientIp(request));
            System.out.println("User-Agent: " + request.getHeader("User-Agent"));
            
            // HTTP ì ‘ê·¼ ë¡œê·¸ ê¸°ë¡
            recordHttpAccess(auth, request, true);
        }
    }
    
    @EventListener
    public void onHttpDenied(AuthorizationDeniedEvent event) {
        if (event.getObject() instanceof HttpServletRequest) {
            HttpServletRequest request = (HttpServletRequest) event.getObject();
            Authentication auth = event.getAuthentication().get();
            
            System.out.println("=== HTTP ìš”ì²­ ì¸ê°€ ê±°ë¶€ ===");
            System.out.println("ì‚¬ìš©ì: " + (auth != null ? auth.getName() : "anonymous"));
            System.out.println("ìš”ì²­: " + request.getMethod() + " " + request.getRequestURI());
            System.out.println("í´ë¼ì´ì–¸íŠ¸ IP: " + getClientIp(request));
            
            // ë³´ì•ˆ ìœ„í˜‘ íƒì§€
            detectSecurityThreat(auth, request);
            recordHttpAccess(auth, request, false);
        }
    }
    
    private String getClientIp(HttpServletRequest request) {
        String clientIp = request.getHeader("X-Forwarded-For");
        if (clientIp == null || clientIp.isEmpty()) {
            clientIp = request.getRemoteAddr();
        }
        return clientIp;
    }
    
    private void recordHttpAccess(Authentication auth, HttpServletRequest request, boolean granted) {
        System.out.println("HTTP ì ‘ê·¼ ê¸°ë¡: " + 
                          (granted ? "ì„±ê³µ" : "ì‹¤íŒ¨") + 
                          " - " + request.getRequestURI());
    }
    
    private void detectSecurityThreat(Authentication auth, HttpServletRequest request) {
        System.out.println("ğŸš¨ ë³´ì•ˆ ìœ„í˜‘ íƒì§€: ë¬´ê¶Œí•œ ì ‘ê·¼ ì‹œë„ - " + request.getRequestURI());
    }
}
```

### 3. ë©”ì„œë“œ ì¸ê°€ ì´ë²¤íŠ¸ ìƒì„¸ ì²˜ë¦¬

```java
@Component
public class MethodAuthorizationEvents {
    
    @EventListener
    public void onMethodGranted(AuthorizationGrantedEvent event) {
        if (event.getObject() instanceof MethodInvocation) {
            MethodInvocation method = (MethodInvocation) event.getObject();
            Authentication auth = event.getAuthentication().get();
            
            System.out.println("=== ë©”ì„œë“œ ì¸ê°€ ì„±ê³µ ===");
            System.out.println("ì‚¬ìš©ì: " + auth.getName());
            System.out.println("ë©”ì„œë“œ: " + getMethodSignature(method));
            System.out.println("íŒŒë¼ë¯¸í„°: " + Arrays.toString(method.getArguments()));
            
            // ë©”ì„œë“œ ì ‘ê·¼ ê°ì‚¬ ë¡œê·¸
            auditMethodAccess(auth, method, true);
        }
    }
    
    @EventListener
    public void onMethodDenied(AuthorizationDeniedEvent event) {
        if (event.getObject() instanceof MethodInvocation) {
            MethodInvocation method = (MethodInvocation) event.getObject();
            Authentication auth = event.getAuthentication().get();
            
            System.out.println("=== ë©”ì„œë“œ ì¸ê°€ ê±°ë¶€ ===");
            System.out.println("ì‚¬ìš©ì: " + (auth != null ? auth.getName() : "anonymous"));
            System.out.println("ë©”ì„œë“œ: " + getMethodSignature(method));
            System.out.println("ì‹œë„ëœ íŒŒë¼ë¯¸í„°: " + Arrays.toString(method.getArguments()));
            
            // ë¬´ê¶Œí•œ ë©”ì„œë“œ ì ‘ê·¼ ì‹œë„ ê¸°ë¡
            auditMethodAccess(auth, method, false);
            alertSecurityTeam(auth, method);
        }
    }
    
    @EventListener
    public void onPostMethodGranted(AuthorizationGrantedEvent event) {
        if (event.getObject() instanceof MethodInvocationResult) {
            MethodInvocationResult result = (MethodInvocationResult) event.getObject();
            Authentication auth = event.getAuthentication().get();
            
            System.out.println("=== ì‚¬í›„ ë©”ì„œë“œ ì¸ê°€ ì„±ê³µ ===");
            System.out.println("ì‚¬ìš©ì: " + auth.getName());
            System.out.println("ë©”ì„œë“œ: " + getMethodSignature(result.getMethodInvocation()));
            System.out.println("ë°˜í™˜ê°’ íƒ€ì…: " + (result.getResult() != null ? 
                              result.getResult().getClass().getSimpleName() : "null"));
            
            // ë°ì´í„° ì ‘ê·¼ ë¡œê·¸ ê¸°ë¡
            logDataAccess(auth, result);
        }
    }
    
    @EventListener
    public void onPostMethodDenied(AuthorizationDeniedEvent event) {
        if (event.getObject() instanceof MethodInvocationResult) {
            MethodInvocationResult result = (MethodInvocationResult) event.getObject();
            Authentication auth = event.getAuthentication().get();
            
            System.out.println("=== ì‚¬í›„ ë©”ì„œë“œ ì¸ê°€ ê±°ë¶€ ===");
            System.out.println("ì‚¬ìš©ì: " + (auth != null ? auth.getName() : "anonymous"));
            System.out.println("ë©”ì„œë“œ: " + getMethodSignature(result.getMethodInvocation()));
            System.out.println("ë°˜í™˜ê°’ì´ ê±°ë¶€ë¨");
            
            // ë¯¼ê°í•œ ë°ì´í„° ì ‘ê·¼ ì‹œë„ ê¸°ë¡
            logSensitiveDataAccessAttempt(auth, result);
        }
    }
    
    private String getMethodSignature(MethodInvocation method) {
        return method.getMethod().getDeclaringClass().getSimpleName() + 
               "." + method.getMethod().getName() + "()";
    }
    
    private void auditMethodAccess(Authentication auth, MethodInvocation method, boolean granted) {
        System.out.println("ë©”ì„œë“œ ì ‘ê·¼ ê°ì‚¬: " + 
                          (granted ? "í—ˆìš©" : "ê±°ë¶€") + 
                          " - " + getMethodSignature(method));
    }
    
    private void alertSecurityTeam(Authentication auth, MethodInvocation method) {
        System.out.println("ğŸš¨ ë³´ì•ˆíŒ€ ì•Œë¦¼: ë¬´ê¶Œí•œ ë©”ì„œë“œ ì ‘ê·¼ - " + getMethodSignature(method));
    }
    
    private void logDataAccess(Authentication auth, MethodInvocationResult result) {
        System.out.println("ë°ì´í„° ì ‘ê·¼ ë¡œê·¸: " + auth.getName() + 
                          " - " + getMethodSignature(result.getMethodInvocation()));
    }
    
    private void logSensitiveDataAccessAttempt(Authentication auth, MethodInvocationResult result) {
        System.out.println("ğŸ”’ ë¯¼ê°í•œ ë°ì´í„° ì ‘ê·¼ ì‹œë„: " + 
                          (auth != null ? auth.getName() : "anonymous"));
    }
}
```

### 4. ì»¤ìŠ¤í…€ ì¸ê°€ ì´ë²¤íŠ¸ ë°œí–‰

```java
@Service
public class CustomAuthorizationService {
    
    private final ApplicationEventPublisher eventPublisher;
    
    public CustomAuthorizationService(ApplicationEventPublisher eventPublisher) {
        this.eventPublisher = eventPublisher;
    }
    
    public void manualAuthorizationCheck(Authentication authentication, Object protectedObject) {
        // ì»¤ìŠ¤í…€ ì¸ê°€ ë¡œì§
        boolean isGranted = performCustomAuthorizationLogic(authentication, protectedObject);
        
        AuthorizationDecision decision = new AuthorizationDecision(isGranted);
        
        // ìˆ˜ë™ ì¸ê°€ ì´ë²¤íŠ¸ ë°œí–‰
        if (isGranted) {
            eventPublisher.publishEvent(new AuthorizationGrantedEvent(() -> authentication, protectedObject, decision));
        } else {
            eventPublisher.publishEvent(new AuthorizationDeniedEvent(() -> authentication, protectedObject, decision));
        }
    }
    
    private boolean performCustomAuthorizationLogic(Authentication authentication, Object protectedObject) {
        // ì»¤ìŠ¤í…€ ì¸ê°€ ë¡œì§ êµ¬í˜„
        return authentication != null && 
               authentication.isAuthenticated() && 
               hasCustomPermission(authentication, protectedObject);
    }
    
    private boolean hasCustomPermission(Authentication authentication, Object protectedObject) {
        // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ë”°ë¥¸ ê¶Œí•œ ê²€ì‚¬
        return true; // ì˜ˆì‹œ
    }
}
```

### 5. ì¸ê°€ ì´ë²¤íŠ¸ ë°œí–‰ì ì„¤ì •

```java
@Configuration
@EnableWebSecurity
public class AuthorizationEventConfig {
    
    @Bean
    public AuthorizationEventPublisher authorizationEventPublisher(ApplicationEventPublisher eventPublisher) {
        return new SpringAuthorizationEventPublisher(eventPublisher);
    }
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http, AuthorizationEventPublisher eventPublisher) throws Exception {
        http
            .authorizeHttpRequests(authorize -> authorize
                .requestMatchers("/public/**").permitAll()
                .requestMatchers("/admin/**").hasRole("ADMIN")
                .anyRequest().authenticated()
            )
            .with(new AuthorizationEventConfigurer(eventPublisher), Customizer.withDefaults());
        
        return http.build();
    }
    
    // ì»¤ìŠ¤í…€ ì„¤ì •ì
    private static class AuthorizationEventConfigurer extends AbstractHttpConfigurer<AuthorizationEventConfigurer, HttpSecurity> {
        
        private final AuthorizationEventPublisher eventPublisher;
        
        public AuthorizationEventConfigurer(AuthorizationEventPublisher eventPublisher) {
            this.eventPublisher = eventPublisher;
        }
        
        @Override
        public void configure(HttpSecurity http) throws Exception {
            AuthorizationFilter authorizationFilter = http.getSharedObject(AuthorizationFilter.class);
            if (authorizationFilter != null) {
                authorizationFilter.setAuthorizationEventPublisher(eventPublisher);
            }
        }
    }
}
```

ì´ë ‡ê²Œ Spring SecurityëŠ” HTTP ìš”ì²­ê³¼ ë©”ì„œë“œ í˜¸ì¶œ ëª¨ë“  ì¸ê°€ ê³¼ì •ì—ì„œ ì²´ê³„ì ìœ¼ë¡œ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•˜ê³ , ê°œë°œìëŠ” `@EventListener`ë¥¼ í†µí•´ ì´ëŸ¬í•œ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•˜ì—¬ **ë³´ì•ˆ ê°ì‚¬**, **ì ‘ê·¼ ë¡œê¹…**, **ìœ„í˜‘ íƒì§€** ë“±ì˜ ì¶”ê°€ì ì¸ ë³´ì•ˆ ê¸°ëŠ¥ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ì»¤ìŠ¤í…€ AuthorizationEventPublisher êµ¬í˜„

```java
@Component
public class CustomAuthorizationEventPublisher implements AuthorizationEventPublisher {
    
    private final ApplicationEventPublisher applicationEventPublisher;
    
    public CustomAuthorizationEventPublisher(ApplicationEventPublisher applicationEventPublisher) {
        this.applicationEventPublisher = applicationEventPublisher;
    }
    
    @Override
    public <T> void publishAuthorizationEvent(Supplier<Authentication> authentication, T object, AuthorizationDecision decision) {
        Authentication auth = authentication.get();
        
        if (decision.isGranted()) {
            // ğŸ”¥ ì¸ê°€ ì„±ê³µ ì‹œ ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ ë°œí–‰
            publishGrantedEvent(authentication, object, decision);
        } else {
            // ğŸ”¥ ì¸ê°€ ê±°ë¶€ ì‹œ ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ ë°œí–‰
            publishDeniedEvent(authentication, object, decision);
        }
    }
    
    private <T> void publishGrantedEvent(Supplier<Authentication> authentication, T object, AuthorizationDecision decision) {
        Authentication auth = authentication.get();
        
        // CustomAuthorizationDecisionì¸ì§€ í™•ì¸
        if (decision instanceof AdminAuthorizationDecision) {
            AdminAuthorizationDecision adminDecision = (AdminAuthorizationDecision) decision;
            
            // ğŸ”¥ ROLE_ADMINì¼ ë•Œ íŠ¹ë³„í•œ ì´ë²¤íŠ¸ ë°œí–‰
            if (adminDecision.isAdmin()) {
                String accessPath = getAccessPath(object);
                String clientIp = getClientIp(object);
                
                // ADMIN ì „ìš© ì´ë²¤íŠ¸ ë°œí–‰
                applicationEventPublisher.publishEvent(
                    new AdminAccessGrantedEvent(authentication, object, decision, accessPath, clientIp)
                );
            }
        } else if (decision instanceof CustomAuthorizationDecision) {
            CustomAuthorizationDecision customDecision = (CustomAuthorizationDecision) decision;
            
            // ì¼ë°˜ ì»¤ìŠ¤í…€ ì¸ê°€ ì„±ê³µ ì´ë²¤íŠ¸ ë°œí–‰
            applicationEventPublisher.publishEvent(
                new CustomAuthorizationGrantedEvent(
                    authentication, 
                    object, 
                    decision, 
                    customDecision.getRequiredRole(),
                    getAccessPath(object)
                )
            );
        } else {
            // ê¸°ë³¸ ì¸ê°€ ì„±ê³µ ì´ë²¤íŠ¸ ë°œí–‰
            applicationEventPublisher.publishEvent(
                new AuthorizationGrantedEvent(authentication, object, decision)
            );
        }
    }
    
    private <T> void publishDeniedEvent(Supplier<Authentication> authentication, T object, AuthorizationDecision decision) {
        if (decision instanceof CustomAuthorizationDecision) {
            CustomAuthorizationDecision customDecision = (CustomAuthorizationDecision) decision;
            
            // ì»¤ìŠ¤í…€ ì¸ê°€ ê±°ë¶€ ì´ë²¤íŠ¸ ë°œí–‰
            applicationEventPublisher.publishEvent(
                new CustomAuthorizationDeniedEvent(
                    authentication, 
                    object, 
                    decision,
                    customDecision.getDecisionReason(),
                    customDecision.getRequiredRole()
                )
            );
        } else {
            // ê¸°ë³¸ ì¸ê°€ ê±°ë¶€ ì´ë²¤íŠ¸ ë°œí–‰
            applicationEventPublisher.publishEvent(
                new AuthorizationDeniedEvent(authentication, object, decision)
            );
        }
    }
    
    private String getAccessPath(Object object) {
        if (object instanceof HttpServletRequest) {
            HttpServletRequest request = (HttpServletRequest) object;
            return request.getMethod() + " " + request.getRequestURI();
        }
        return object.toString();
    }
    
    private String getClientIp(Object object) {
        if (object instanceof HttpServletRequest) {
            HttpServletRequest request = (HttpServletRequest) object;
            String clientIp = request.getHeader("X-Forwarded-For");
            if (clientIp == null || clientIp.isEmpty()) {
                clientIp = request.getRemoteAddr();
            }
            return clientIp;
        }
        return "unknown";
    }
}
```

```java
// ì»¤ìŠ¤í…€ AuthorizationDecision í´ë˜ìŠ¤
public class CustomAuthorizationDecision extends AuthorizationDecision {
    
    private final String decisionReason;
    private final String requiredRole;
    
    public CustomAuthorizationDecision(boolean granted, String decisionReason, String requiredRole) {
        super(granted);
        this.decisionReason = decisionReason;
        this.requiredRole = requiredRole;
    }
    
    public String getDecisionReason() {
        return decisionReason;
    }
    
    public String getRequiredRole() {
        return requiredRole;
    }
}

// ADMIN ì „ìš© AuthorizationDecision
public class AdminAuthorizationDecision extends CustomAuthorizationDecision {
    
    private final boolean isAdmin;
    
    public AdminAuthorizationDecision(boolean granted, String decisionReason, boolean isAdmin) {
        super(granted, decisionReason, "ROLE_ADMIN");
        this.isAdmin = isAdmin;
    }
    
    public boolean isAdmin() {
        return isAdmin;
    }
}
```